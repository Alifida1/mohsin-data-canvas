WITH agg AS (
    SELECT
        "Age" AS age_group,
        COUNT(*) AS total_patients,
        SUM(CASE WHEN "Diabetes_binary" = 1 THEN 1 ELSE 0 END) AS diabetes_cases,
        AVG("BMI") AS avg_bmi,
        AVG("HighBP") AS pct_highbp,
        AVG("HighChol") AS pct_highchol,
        AVG("Smoker") AS pct_smoker,
        AVG("PhysActivity") AS pct_physactive,
        AVG("HvyAlcoholConsump") AS pct_heavy_alcohol
    FROM public."Transformed_Diabetes"
    GROUP BY "Age"
)
SELECT
    age_group,
    total_patients,
    diabetes_cases,
    ROUND((diabetes_cases::numeric / NULLIF(total_patients, 0)) * 100, 1) AS diabetes_rate_pct,
    ROUND(avg_bmi::numeric, 1) AS avg_bmi,
    ROUND((pct_highbp::numeric * 100), 1)       AS pct_highbp,
    ROUND((pct_highchol::numeric * 100), 1)     AS pct_highchol,
    ROUND((pct_smoker::numeric * 100), 1)       AS pct_smoker,
    ROUND((pct_physactive::numeric * 100), 1)   AS pct_physactive,
    ROUND((pct_heavy_alcohol::numeric * 100),1) AS pct_heavy_alcohol,
    RANK() OVER (ORDER BY diabetes_cases DESC) AS diabetes_burden_rank
FROM agg
ORDER BY diabetes_rate_pct DESC;
